import{U as N,A as i,_ as u,q,l as R,Q as b}from"./mockInPageEdit.ClTvjmtP.js";import{c as _}from"./makeCallable-LDU0xZMJ.BgixzwPG.js";import{n as S}from"./Preferences-DS4-CFWe.DlUhv_7c.js";import{g as k}from"./index-lZkYoUca.CvgPwRJC.js";import{b as C}from"./InputBox-BV4m05Xs.Ch0mGp1p.js";import{o as E}from"./noop-ClDc6zv4.BarqedVQ.js";import"./framework.DMidvyNK.js";var M=Object.create,f=Object.defineProperty,O=Object.getOwnPropertyDescriptor,v=(o,e)=>(e=Symbol[o])?e:Symbol.for("Symbol."+o),y=o=>{throw TypeError(o)},j=(o,e,a)=>e in o?f(o,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[e]=a,B=(o,e)=>f(o,"name",{value:e,configurable:!0}),F=o=>[,,,M(o?.[v("metadata")]??null)],L=["class","method","getter","setter","accessor","field","value","get","set"],P=o=>o!==void 0&&typeof o!="function"?y("Function expected"):o,Q=(o,e,a,r,t)=>({kind:L[o],name:e,metadata:r,addInitializer:n=>a._?y("Already initialized"):t.push(P(n||null))}),A=(o,e)=>j(e,v("metadata"),o[3]),U=(o,e,a,r)=>{for(var t=0,n=o[e>>1],s=n&&n.length;t<s;t++)n[t].call(a);return r},z=(o,e,a,r,t,n)=>{var s,h,l,c=e&7,d=!1,w=0,T=o[w]||(o[w]=[]),g=c&&(t=t.prototype,c<5&&(c>3||!d)&&O(t,a));B(t,a);for(var p=r.length-1;p>=0;p--)l=Q(c,a,h={},o[3],T),s=(0,r[p])(t,l),h._=1,P(s)&&(t=s);return A(o,t),g&&f(t,a,g),d?c^4?n:g:t},D,x,I;D=[R(["api","wikiPage","wikiTitle","currentPage","wiki","modal","preferences"]),S(b.object({deleteReason:b.string().description("Default delete reason for quick delete").default("[IPE-NEXT] Quick delete")}).description("Quick delete options").extra("category","delete"))];class m extends(I=N){constructor(e){super(e,{},"quick-delete"),this.ctx=e,this.DEFAULT_OPTIONS={title:"",pageId:0,revision:0,deleteReason:"",reloadAfterDelete:!0},this.ctx.root.set("quickDelete",_(this,"showModal"))}start(){this.ctx.inject(["toolbox"],e=>{this.injectToolbox(e),e.on("dispose",()=>{this.removeToolbox(e)})}),this.ctx.preferences.defineCategory({label:"Delete",name:"delete",description:"Settings related to deleting pages",index:3})}async showModal(e){if(typeof e>"u"?e={}:typeof e=="string"&&(e={title:e}),!e.title&&!e.pageId&&!e.revision){this.logger.warn("None of the title, pageId or revision provided. Using defaults.");const l=new URLSearchParams(window.location.search),c=this.ctx.currentPage.wikiTitle;e={...e,title:c?.getPrefixedDBKey(),revision:l.has("oldid")?Number(l.get("oldid")):void 0,pageId:l.has("curid")?Number(l.get("curid")):void 0}}const a=typeof e.deleteReason=="string"?e.deleteReason:await this.ctx.preferences.get("deleteReason"),r={...this.DEFAULT_OPTIONS,deleteReason:a,...e};r.deleteReason||(r.deleteReason=await this.ctx.preferences.get("deleteReason")||""),r||this.ctx.emit("quick-delete/init-options",{ctx:this.ctx,options:r});const t=this.ctx.modal.createObject({className:"ipe-quickDelete",sizeClass:"small",center:!0}).init();t.setTitle(i(u,{children:["Loading: ",i("u",{children:r.title})]})),t.setContent(i(q,{})),t.addButton({side:"right",type:"button",className:"is-ghost",label:"Cancel",method(){t.close()}}),t.show(),this.ctx.emit("quick-delete/show-modal",{ctx:this.ctx,modal:t,options:r});let n;try{if(n=await this.getWikiPageFromPayload(r),n.pageInfo.special)throw new Error("Special page cannot be deleted");if(n.pageInfo.pageid===0)throw new Error("Page does not exist, cannot be deleted")}catch(l){t.off(t.Event.Close),t.close(),this.ctx.modal.notify("error",{content:l instanceof Error?l.message:String(l)});return}t.setTitle(i(u,{children:["Quick Delete: ",i("u",{children:n.pageInfo.title})]}));const s=[];n.userCan("delete")||s.push(i(k,{title:"Permission Denied",type:"error",children:i("p",{children:"You do not have permission to delete this page."})})),n.pageInfo.protection&&n.pageInfo.protection.length>0&&s.push(i(k,{title:"Warning",type:"warning",children:i("p",{children:"This page is protected and may has special use or purpose. Delete it at your own risk."})})),this.ctx.emit("quick-delete/delete-notice",{ctx:this.ctx,options:r,modal:t,wikiPage:n,deleteNotices:s});const h=i("form",{className:"ipe-quickDelete__form",children:[i("div",{className:"ipe-quickDelete__notices",children:s}),i("div",{className:"ipe-quickDelete__content",children:i("div",{className:"ipe-quickDelete__page-info",style:{padding:"1rem",backgroundColor:"#f8f9fa",border:"1px solid #dee2e6",borderRadius:"4px",marginBottom:"1rem"},children:i("ul",{children:[i("li",{children:[i("strong",{children:"Title:"})," ",n.pageInfo.title]}),i("li",{children:[i("strong",{children:"Page ID:"})," ",n.pageInfo.pageid]}),i("li",{children:[i("strong",{children:"Last Revision:"})," ",n.pageInfo.lastrevid]}),i("li",{children:[i("strong",{children:"Length:"})," ",n.pageInfo.length," characters"]})]})})}),i("div",{class:"ipe-quickDelete__options",style:{display:"flex",flexDirection:"column",gap:"1rem",marginTop:"1rem"},children:i(C,{label:"Delete Reason",id:"reason",name:"reason",value:r.deleteReason,inputProps:{placeholder:"Enter reason for deletion...",required:!0}})}),!1]});t.setContent(h),t.addButton({side:"left",className:"is-danger submit-btn",label:"Delete Page",method:()=>{const l=new FormData(h).get("reason");if(!l||l.trim()===""){this.ctx.modal.notify("error",{title:"Missing Reason",content:"Please provide a reason for deletion."});return}this.ctx.modal.confirm({className:"is-danger",title:"Confirm Deletion",content:i(u,{children:i("p",{children:i("strong",{children:n.pageInfo.title})})}),center:!0,okBtn:{label:"Delete it now",className:"is-danger"},cancelBtn:{label:"Cancel",className:"is-ghost"}},c=>(c&&(t.setLoadingState(!0),this.handleSubmit({wikiPage:n,reason:l}).then(async()=>{t.setOptions({beforeClose:E}),t.close(),this.ctx.modal.notify("success",{title:"Deletion Successful",content:`The page "${n.pageInfo.title}" has been deleted.`})}).catch(d=>{this.ctx.modal.notify("error",{title:"Deletion Error",content:d instanceof Error?d.message:String(d)}),t.setLoadingState(!1)})),!0))}},0),this.ctx.emit("quick-delete/wiki-page",{ctx:this.ctx,options:r,modal:t,wikiPage:n})}async handleSubmit(e){const a=e.wikiPage,r=e.reason||"";return a.delete(r)}async getWikiPageFromPayload(e){if(e.revision)return this.ctx.wikiPage.newFromRevision(e.revision);if(e.pageId)return this.ctx.wikiPage.newFromPageId(e.pageId);if(e.title)return this.ctx.wikiPage.newFromTitle(e.title,!1);throw new Error("Invalid payload")}async injectToolbox(e){const a=this.ctx.currentPage.wikiTitle,r=a&&this.ctx.wiki.hasRight("delete")&&a.getNamespaceId()>=0;e.toolbox.addButton({id:"quick-delete",group:"group2",icon:i("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"icon icon-tabler icons-tabler-outline icon-tabler-trash",children:[i("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),i("path",{d:"M4 7l16 0"}),i("path",{d:"M10 11l0 6"}),i("path",{d:"M14 11l0 6"}),i("path",{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"}),i("path",{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"})]}),buttonProps:{disabled:!r},tooltip:r?"Quick Delete":"Not deletable",onClick:()=>{this.showModal({title:a?.getPrefixedText()})}})}removeToolbox(e){e.toolbox.removeButton("quick-delete")}}x=F(I);m=z(x,0,"PluginQuickDelete",D,m);U(x,1,m);export{m as PluginQuickDelete};
