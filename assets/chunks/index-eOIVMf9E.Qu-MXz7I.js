import{U as E,A as i,q as $,_ as C,l as q,Q as b}from"./mockInPageEdit.ClTvjmtP.js";import{n as z}from"./IconQuickEdit-CAL1HXIb.BzkiS42D.js";import{n as O}from"./Preferences-DS4-CFWe.DlUhv_7c.js";import{g as j}from"./index-lZkYoUca.CvgPwRJC.js";import"./framework.DMidvyNK.js";const U=t=>{let{user:e,target:r,ctx:a}=t;const o=a.getUrl.bind(a);return i("span",{className:"mw-userlinks",children:[i("a",{href:o(`User:${e}`),className:"mw-userlink",target:r,children:e})," ",i("span",{className:"mw-usertoollinks",children:["(",i("a",{href:o(`User_talk:${e}`),className:"mw-usertoollinks-talk",target:r,children:"talk"})," | ",i("a",{href:o(`Special:Contributions/${e}`),className:"mw-usertoollinks-contribs",target:r,children:"contribs"})," | ",i("a",{href:o(`Special:Block/${e}`),className:"mw-usertoollinks-block",target:r,children:"block"}),")"]})]})};var m=(t=>(t.update="ipe:diff-table/update",t.edit="ipe:diff-table/edit",t))(m||{});const _=new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"medium"}).format,k=t=>{let e=["diff-title"];if(t.type==="from"?e.push("diff-otitle"):t.type==="to"&&e.push("diff-ntitle"),!t.pageid||!t.userid)return i("td",{colSpan:2,className:e,children:i("div",{className:"mw-diff-title--title",children:t.type==="from"?"Original content":t.type==="to"?"Your content":""})});const r=a=>{a.preventDefault(),a.target.dispatchEvent(new CustomEvent("ipe:diff-table/edit",{detail:{revid:t.revid},bubbles:!0}))};return i("td",{colSpan:2,className:e,children:[i("div",{className:"mw-diff-title--title",children:[t.pagetitle||t.timestamp,t.revid?` (rev#${t.revid})`:""]}),i("div",{className:"mw-diff-title--actions",children:i("a",{href:t.ctx.getUrl("",{action:"edit",oldid:t.revid}),onClick:r,children:[i(z,{style:"width: 1em; height: 1em"}),"Quick edit"]})}),i("div",{className:"mw-diff-title--user",children:t.username&&i(U,{ctx:t.ctx,user:t.username,target:"_blank"})}),i("div",{className:"mw-diff-title--timestamp",children:t.timestamp&&_(new Date(t.timestamp))}),i("div",{className:"mw-diff-title--comment",children:t.parsedcomment&&i(C,{children:["(",i("i",{innerHTML:t.parsedcomment}),")"]})})]})},A=t=>{const e=t.data;if(!e.prev&&!e.next)return null;const r=(a,o,s)=>{a.preventDefault(),a.target.dispatchEvent(new CustomEvent("ipe:diff-table/update",{detail:{fromrev:o,torev:s},bubbles:!0}))};return i("tr",{className:"mw-diff-title--navigation",children:[i("td",{colSpan:2,children:e.prev?i("a",{href:t.ctx.getUrl("",{diff:e.prev,oldid:e.fromrevid}),onClick:a=>r(a,e.prev,e.fromrevid),children:"← Previous"}):i("i",{children:"Oldest version"})}),i("td",{colSpan:2,children:e.next?i("a",{href:t.ctx.getUrl("",{diff:e.next,oldid:e.torevid}),onClick:a=>r(a,e.torevid,e.next),children:"Next →"}):i("i",{children:"Newest version"})})]})},Q=t=>{const{data:e,...r}=t,a=i("table",{className:"theme-ipe diff diff-type-table","data-mw":"interface",...r,children:[i("colgroup",{children:[i("col",{className:"diff-marker"}),i("col",{className:"diff-content"}),i("col",{className:"diff-marker"}),i("col",{className:"diff-content"})]}),i("tbody",{children:[i("tr",{children:[i(k,{ctx:t.ctx,type:"from",pageid:e.fromid,pagetitle:e.fromtitle,revid:e.fromrevid,size:e.fromsize,timestamp:e.fromtimestamp,username:e.fromuser,userid:e.fromuserid,comment:e.fromcomment,parsedcomment:e.fromparsedcomment}),i(k,{ctx:t.ctx,type:"to",pageid:e.toid,pagetitle:e.totitle,revid:e.torevid,size:e.tosize,timestamp:e.totimestamp,username:e.touser,userid:e.touserid,comment:e.tocomment,parsedcomment:e.toparsedcomment})]}),i(A,{data:e,ctx:t.ctx}),i("div",{id:"diffbody"}),i("tr",{className:"diff-size",style:{textAlign:"center"},children:[i("td",{colSpan:2,className:"diff-size-old",children:e.fromsize!==void 0&&`${e.fromsize} bytes`}),i("td",{colSpan:2,className:"diff-size-new",children:e.tosize!==void 0&&`${e.tosize} bytes`})]})]})]});return a.querySelector("#diffbody").outerHTML=e.body||i("tr",{children:i("td",{colSpan:4,children:i("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"5rem"},children:i("i",{children:"No changes"})})})}).outerHTML,a},T=(t,e=document)=>e.querySelector(t),L=(t,e=document)=>e.querySelectorAll(t);var I=Object.create,h=Object.defineProperty,F=Object.getOwnPropertyDescriptor,w=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),x=t=>{throw TypeError(t)},H=(t,e,r)=>e in t?h(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,M=(t,e)=>h(t,"name",{value:e,configurable:!0}),B=t=>[,,,I(t?.[w("metadata")]??null)],R=["class","method","getter","setter","accessor","field","value","get","set"],N=t=>t!==void 0&&typeof t!="function"?x("Function expected"):t,K=(t,e,r,a,o)=>({kind:R[t],name:e,metadata:a,addInitializer:s=>r._?x("Already initialized"):o.push(N(s||null))}),Y=(t,e)=>H(e,w("metadata"),t[3]),G=(t,e,r,a)=>{for(var o=0,s=t[e>>1],n=s&&s.length;o<n;o++)s[o].call(r);return a},J=(t,e,r,a,o,s)=>{var n,d,c,l=e&7,g=!1,y=0,D=t[y]||(t[y]=[]),f=l&&(o=o.prototype,l<5&&(l>3||!g)&&F(o,r));M(o,r);for(var u=a.length-1;u>=0;u--)c=K(l,r,d={},t[3],D),n=(0,a[u])(o,c),d._=1,N(n)&&(o=n);return Y(t,o),f&&h(o,r,f),g?l^4?s:f:o},P,v,S;P=[q(["wiki","getUrl","preferences"]),O(b.object({"quickDiff.keyshortcut":b.string().default("ctrl-d").description("Key shortcut to open quick diff in quick edit modal")}).description("Quick diff options").extra("category","edit"))];class p extends(S=E){constructor(e){super(e,{},"quick-diff"),this.ctx=e,this.COMPARE_API_DEFAULT_OPTIONS={prop:["comment","diff","diffsize","ids","parsedcomment","size","timestamp","title","user","rel"].join("|"),difftype:"table"}}start(){this.ctx.set("quickDiff",this),this.ctx.on("quick-edit/wiki-page",this.injectQuickEdit.bind(this)),window.RLQ.push(this.injectHistoryPage.bind(this))}stop(){}injectHistoryPage(){const e=T("#mw-history-compare");e&&L(".mw-history-compareselectedversions-button",e).forEach(r=>{r.after(i("button",{className:"cdx-button",onClick:a=>{a.preventDefault();const o=new FormData(e),s=Number(o.get("oldid"))||0,n=Number(o.get("diff"))||0;if(!o.get("title")||!s||!n)return this.logger.warn("Missing title or revision IDs");this.comparePages({fromrev:s,torev:n})},children:"Quick Diff"}))})}async injectQuickEdit({modal:e,wikiPage:r,options:a}){if(r.pageid===0||a.section==="new")return;let o;e.addButton({label:"Diff",side:"left",keyPress:await this.ctx.preferences.get("quickDiff.keyshortcut")||void 0,className:"btn btn-secondary",method:()=>{const s=r.title,n=r.revisions?.[0]?.content||"",d=e.get$content().querySelector('textarea[name="text"]')?.value||"";return n===d?this.ctx.modal.notify("info",{title:"Quick Diff",content:"No changes"}):(o=this.comparePages({fromtitle:s,fromtext:n,totitle:s,totext:d,topst:!0},o,{backdrop:!1,draggable:!0}),o)}},2),e.on(e.Event.Close,()=>{o?.destroy(),o=void 0})}comparePages(e,r,a){return!r||r.isDestroyed?r=this.ctx.modal.createObject({title:"Loading diff...",content:"",className:"quick-diff",center:!1,...a}).init():r.removeButton("*"),r.setContent(i("section",{style:{height:"70vh",display:"flex",justifyContent:"center",alignItems:"center"},children:i($,{})})),r.bringToFront(),window.mw&&mw.loader.getState("mediawiki.diff.styles")!=="ready"&&mw.loader.load(["mediawiki.diff.styles"]),this.ctx.api.post({...this.COMPARE_API_DEFAULT_OPTIONS,...e,action:"compare",format:"json",formatversion:2}).then(o=>{if(!o.data.compare)throw new Error("No compare data received",{cause:o});const{data:{compare:s}}=o;r.setTitle(s.fromtitle&&s.totitle?`${s.fromtitle}${s.fromrevid?` (${s.fromrevid})`:""} ⇔ ${s.totitle}${s.torevid?` (${s.torevid})`:""}`:"Differences");let n;r.setContent(i("section",{style:{minHeight:"70vh"},children:i(Q,{ref:d=>n=d,data:s,ctx:this.ctx})})),n.addEventListener(m.update,d=>{d.stopPropagation(),this.comparePages({fromrev:d.detail.fromrev,torev:d.detail.torev},r,a)},{once:!0}),this.ctx.inject(["quickEdit"],d=>{const c=l=>{l.stopPropagation(),d.quickEdit({revision:l.detail.revid})};n.addEventListener(m.edit,c),r.on(r.Event.Close,()=>{n.removeEventListener(m.edit,c)})}),s.fromrevid&&s.torevid&&r.addButton({label:"Original Compare Page",side:"right",className:"btn btn-secondary",method:()=>{window.location.href=this.ctx.getUrl("",{oldid:s.fromrevid,diff:s.torevid})}})}).catch(o=>{r.setContent(i(j,{title:"Failed to load diff",type:"error",children:i("pre",{children:o instanceof Error?o.message:String(o)})}))}),r.show()}}v=B(S);p=J(v,0,"PluginQuickDiff",P,p);G(v,1,p);export{p as PluginQuickDiff};
