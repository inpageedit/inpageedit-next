import{U as M,A as d,l as D,Q as m}from"./mockInPageEdit.ClTvjmtP.js";import{n as N}from"./Preferences-DS4-CFWe.DlUhv_7c.js";import{n as S}from"./IconQuickEdit-CAL1HXIb.BzkiS42D.js";import"./framework.DMidvyNK.js";var j=Object.create,w=Object.defineProperty,$=Object.getOwnPropertyDescriptor,v=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),y=t=>{throw TypeError(t)},C=(t,e,r)=>e in t?w(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,T=(t,e)=>w(t,"name",{value:e,configurable:!0}),W=t=>[,,,j(t?.[v("metadata")]??null)],_=["class","method","getter","setter","accessor","field","value","get","set"],x=t=>t!==void 0&&typeof t!="function"?y("Function expected"):t,Q=(t,e,r,l,i)=>({kind:_[t],name:e,metadata:l,addInitializer:n=>r._?y("Already initialized"):i.push(x(n||null))}),O=(t,e)=>C(e,v("metadata"),t[3]),P=(t,e,r,l)=>{for(var i=0,n=t[e>>1],a=n&&n.length;i<a;i++)n[i].call(r);return l},z=(t,e,r,l,i,n)=>{var a,f,s,o=e&7,c=!1,u=0,p=t[u]||(t[u]=[]),h=o&&(i=i.prototype,o<5&&(o>3||!c)&&$(i,r));T(i,r);for(var k=l.length-1;k>=0;k--)s=Q(o,r,f={},t[3],p),a=(0,l[k])(i,s),f._=1,x(a)&&(i=a);return O(t,i),h&&w(i,r,h),c?o^4?n:h:i},q,A,E;q=[D(["wiki","wikiTitle","preferences"]),N(m.object({"inArticleLinks.enable":m.boolean().description("Whether to enable in-article links").default(!0),"inArticleLinks.quickDiff.enable":m.boolean().description("Whether to enable in-article links for quick diff").default(!0),"inArticleLinks.quickEdit.enable":m.boolean().description("Whether to enable in-article links for quick edit").default(!0),"inArticleLinks.quickEdit.redlinks":m.boolean().description("Whether to show quick edit button for redlinks").default(!0)}).description("In-article links preferences").extra("category","in-article-links"))];class g extends(E=M){constructor(e){super(e,{linkClassName:"ipe__in-article-link"},"InArticleLinks"),this._cachedAnchorInfo=new WeakMap,this.ctx.set("inArticleLinks",this),this.ctx.preferences.defineCategory({label:"In Article Links",name:"in-article-links",description:"In-article links preferences",index:9})}async start(){await this.ctx.preferences.get("inArticleLinks.quickEdit.enable")&&this.handleQuickEdit(),await this.ctx.preferences.get("inArticleLinks.quickDiff.enable")&&this.handleQuickDiff()}async stop(){Array.from(document.getElementsByClassName(this.config.linkClassName)).forEach(e=>{e.remove()}),document.querySelectorAll("[data-ipe-edit-mounted]").forEach(e=>{e.dataset.ipeEditMounted=void 0})}parseAnchor(e){if(!(e instanceof HTMLAnchorElement))return null;const r=this._cachedAnchorInfo.get(e);if(r)return r;const l=e.getAttribute("href")||"";if(!this.ctx.wikiTitle.validateHrefAttr(l))return null;const i=e.href||"",n=this.ctx.wikiTitle.parseWikiLink(i);if(!n)return null;const a={$el:e,kind:e.closest('[typeof^="mw:File"]')?"mw:File":"normal",external:e.classList.contains("external")||!!l.startsWith("http"),redlink:e.classList.contains("new")||n.params.has("redlink"),...n};return this._cachedAnchorInfo.set(e,a),a}scanAnchors(e,r){const l=e.querySelectorAll("a[href]");return Array.from(l).map(i=>this.parseAnchor(i)).filter(i=>i!==null&&(!r||r(i)))}async handleQuickEdit(){let e=!1;const r=await this.ctx.preferences.get("inArticleLinks.quickEdit.redlinks");this.ctx.inject(["quickEdit"],l=>{e=!0,l.on("dispose",()=>{e=!1}),window?.mw?.hook?.("wikipage.content").add(i=>{e&&this.scanAnchors(i.get(0),({action:n,title:a,redlink:f})=>r||!f?["edit","create"].includes(n)?!0:a?.isSpecial("edit")||a?.isSpecial("newsection")?a.getMainText().split("/").length>=2:!1:!1).forEach(({$el:n,title:a,pageId:f,params:s})=>{if(n.dataset.ipeEditMounted)return;if(n.dataset.ipeEditMounted="1",s.has("preload")||s.has("redo"))return this.ctx.logger.debug(n,"Not compatible with quick edit");const o=a?.getPrefixedDBKey()||"",c=s.get("section")?.replace(/^T-/,"")||void 0,u=s.get("oldid"),p=s.has("redlink");let h;c==="new"||a?.isSpecial("newsection")?h="new":c&&/^\d+$/.test(c)&&(h=parseInt(c,10));const k=u?parseInt(u,10):void 0,b={title:o,pageId:f||void 0,section:h,revision:k,createOnly:p},I=d("a",{href:"#ipe://quick-edit/",dataset:b,className:`${this.config.linkClassName} ipe-quick-edit ${p?"ipe-quick-edit--create-only":""}`,style:{userSelect:"none",marginLeft:"0.2em"},onClick:L=>{L.preventDefault(),l.quickEdit.showModal(b)},children:d(S,{className:"ipe-icon"})});n.insertAdjacentElement("afterend",I)})})})}handleQuickDiff(){let e=!1;const r=l=>["prev","next","cur"].includes(l);this.ctx.inject(["quickDiff"],l=>{e=!0,l.on("dispose",()=>{e=!1}),window?.mw?.hook?.("wikipage.content").add(i=>{e&&this.scanAnchors(i.get(0),({params:n,title:a})=>!!(n.has("diff")||a?.isSpecial("diff"))).forEach(({$el:n,title:a,params:f})=>{if(n.dataset.ipeDiffMounted)return;n.dataset.ipeDiffMounted="1";let s,o;if(a?.getNamespaceId()===-1?([,o,s]=a.getMainDBKey().split("/"),s||(s="prev")):(s=f.get("diff"),o=f.get("oldid")),!s||!o)return;const c={};r(s)?(c.fromrev=parseInt(o),c.torelative=s):(c.fromrev=parseInt(o),c.torev=parseInt(s));const u=d("a",{href:"#ipe://quick-diff/",dataset:c,className:`${this.config.linkClassName} ipe-quick-diff`,style:{userSelect:"none",marginLeft:"0.2em"},onClick:p=>{p.preventDefault(),l.quickDiff.comparePages(c)},children:d("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"icon icon-tabler icons-tabler-outline icon-tabler-file-diff ipe-icon",children:[d("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),d("path",{d:"M14 3v4a1 1 0 0 0 1 1h4"}),d("path",{d:"M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"}),d("path",{d:"M12 10l0 4"}),d("path",{d:"M10 12l4 0"}),d("path",{d:"M10 17l4 0"})]})});n.insertAdjacentElement("afterend",u)})})})}}A=W(E);g=z(A,0,"PluginInArticleLinks",q,g);P(A,1,g);export{g as PluginInArticleLinks};
