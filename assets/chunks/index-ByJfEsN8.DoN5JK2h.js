import{A as t,U as D,_ as k,y as h,q as F,l as L,Q as u}from"./mockInPageEdit.dGXzNdjP.js";import{c as j}from"./makeCallable-LDU0xZMJ.BgixzwPG.js";import{n as B}from"./Preferences-DS4-CFWe.DlUhv_7c.js";import{g as q}from"./index-lZkYoUca.CM9QqBzU.js";import{b as N}from"./InputBox-BV4m05Xs.CAsaNFkw.js";import{h as T}from"./CheckBox-D3rHnX7I.1sNjju7J.js";import{o as I}from"./noop-ClDc6zv4.BarqedVQ.js";import"./framework.DeVdP8gD.js";const Q=i=>{const{id:e,name:n,value:l,label:r,inputProps:d,labelProps:s,children:o,...c}=i;return t("label",{className:"theme-ipe ipe-radio-box",...c,children:[t("input",{type:"radio",id:e,name:n,value:l,...d}),t("span",{className:"ipe-checkbox-box"}),t("span",{...s,children:r||o})]})},U=(i=0)=>new Promise(e=>setTimeout(e,i));var $=Object.create,S=Object.defineProperty,R=Object.getOwnPropertyDescriptor,C=(i,e)=>(e=Symbol[i])?e:Symbol.for("Symbol."+i),A=i=>{throw TypeError(i)},W=(i,e,n)=>e in i?S(i,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[e]=n,z=(i,e)=>S(i,"name",{value:e,configurable:!0}),K=i=>[,,,$(i?.[C("metadata")]??null)],Y=["class","method","getter","setter","accessor","field","value","get","set"],_=i=>i!==void 0&&typeof i!="function"?A("Function expected"):i,G=(i,e,n,l,r)=>({kind:Y[i],name:e,metadata:l,addInitializer:d=>n._?A("Already initialized"):r.push(_(d||null))}),H=(i,e)=>W(e,C("metadata"),i[3]),X=(i,e,n,l)=>{for(var r=0,d=i[e>>1],s=d&&d.length;r<s;r++)d[r].call(n);return l},J=(i,e,n,l,r,d)=>{var s,o,c,p=e&7,f=!1,y=0,v=i[y]||(i[y]=[]),w=p&&(r=r.prototype,p<5&&(p>3||!f)&&R(r,n));z(r,n);for(var m=l.length-1;m>=0;m--)c=G(p,n,o={},i[3],v),s=(0,l[m])(r,c),o._=1,_(s)&&(r=s);return H(i,r),w&&S(r,n,w),f?p^4?d:w:r},M,E,O;M=[L(["api","wikiPage","wikiTitle","currentPage","wiki","modal","preferences"]),B(u.object({"quickEdit.editSummary":u.string().description("Default edit summary for quick edits").default("[IPE-NEXT] Quick edit"),"quickEdit.editMinor":u.boolean().description("Whether to mark the edit as minor").default(!1),"quickEdit.outSideClose":u.boolean().description("Whether to close the modal outside").default(!0),"quickEdit.watchList":u.union([u.const(h.preferences).description("Follow my preferences"),u.const(h.nochange).description("Keep the current watchlist status"),u.const(h.watch).description("Add the page to watchlist"),u.const(h.unwatch).description("Remove the page from watchlist")]).description("Watchlist options").default(h.preferences),"quickEdit.keyshortcut.save":u.string().default("ctrl-s").description("save button key shortcut (blank to disable)")}).description("Quick edit options").extra("category","edit"))];class b extends(O=D){constructor(e){super(e,{},"quick-edit"),this.ctx=e,this.DEFAULT_OPTIONS={title:"",pageId:0,revision:0,section:void 0,editMinor:!1,editSummary:"",createOnly:!1,reloadAfterSave:!0},this.ctx.root.set("quickEdit",j(this,"showModal"))}start(){this.ctx.inject(["toolbox"],e=>{this.injectToolbox(e),e.on("dispose",()=>{this.removeToolbox(e)})})}async showModal(e){if(typeof e>"u"?e={}:typeof e=="string"&&(e={title:e}),e?.page&&(e.title=e.page,delete e.page),!e.title&&!e.pageId&&!e.revision){this.logger.warn("None of the title, pageId or revision provided. Using defaults.");const a=new URLSearchParams(window.location.search),g=this.ctx.currentPage.wikiTitle;e={...e,title:g?.getPrefixedDBKey(),revision:a.has("oldid")?Number(a.get("oldid")):void 0,pageId:a.has("curid")?Number(a.get("curid")):void 0}}if(!e.revision&&!e.pageId&&e.title){const a=this.ctx.wikiTitle.resolveSpecialPageTarget(e.title);a&&a.title.getNamespaceId()>=0&&(e.title=a.title.getPrefixedDBKey(),e.section??=a.section)}const n=await this.ctx.preferences.get("quickEdit.outSideClose"),l=await this.ctx.preferences.get("quickEdit.watchList"),r=typeof e.editSummary=="string"?e.editSummary:await this.ctx.preferences.get("quickEdit.editSummary"),d=typeof e.editMinor=="boolean"?e.editMinor:await this.ctx.preferences.get("quickEdit.editMinor"),s={...this.DEFAULT_OPTIONS,editSummary:r,editMinor:d,...e};s.editSummary||(s.editSummary=await this.ctx.preferences.get("quickEdit.editSummary")||""),this.ctx.emit("quick-edit/init-options",{ctx:this.ctx,options:s});const o=this.ctx.modal.createObject({className:"ipe-quickEdit",sizeClass:"large",center:!1,outSideClose:n}).init();o.setTitle(t(k,{children:["Loading: ",t("u",{children:s.title})]})),o.setContent(t("section",{className:"ipe-quickEdit-loading",style:{height:"70vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"},children:t(F,{})})),o.addButton({side:"right",type:"button",className:"is-danger is-ghost",label:"Cancel",method(){o.close()}}),o.show(),this.ctx.emit("quick-edit/show-modal",{ctx:this.ctx,modal:o,options:s});let c;try{if(c=await this.getWikiPageFromPayload(s),c.pageInfo.special)throw new Error("Special page is not editable")}catch(a){o.off(o.Event.Close),o.close(),this.ctx.modal.notify("error",{content:a instanceof Error?a.message:String(a)});return}const p=s.section==="new"?"":c.revisions[0]?.content||"",f=c.revisions[0]?.revid,y=f&&f!==c.lastrevid,v=s.section==="new",w=c.pageid===0;o.setTitle(t(k,{children:[v?"New section":`Quick ${w?"Create":"Edit"}`,":"," ",t("u",{children:c.pageInfo.title}),y?` (Revision ${f})`:""]}));const m=[];w&&m.push(t(q,{title:"Attention",type:"important",children:t("p",{children:"This page does not exist."})})),y&&m.push(t(q,{title:"Attention",type:"warning",children:t("p",{children:["You are editing a ",t("em",{children:"historical version"}),"; the content is not the latest!"]})})),this.ctx.emit("quick-edit/edit-notice",{ctx:this.ctx,options:s,modal:o,wikiPage:c,editNotices:m});const x=t("form",{className:"ipe-quickEdit__form",children:[t("div",{className:"ipe-quickEdit__notices",children:m}),t("div",{className:"ipe-quickEdit__content",style:{display:"flex",flexDirection:"column",gap:"1rem"},children:[s.section==="new"&&t(k,{children:t(N,{label:"Section title",id:"summary",name:"summary",value:"",inputProps:{placeholder:"Topic for new section, this will be the h2 heading"}})}),t("textarea",{className:"ipe-quickEdit__textarea",name:"text",id:"wpTextbox1",children:p})]}),t("div",{class:"ipe-quickEdit__options",style:{display:"flex",flexDirection:"column",gap:"1rem",marginTop:"1rem"},children:[!v&&t(N,{label:"Summary",id:"summary",name:"summary",value:s.editSummary}),t("div",{className:"ipe-input-box",children:[t("label",{htmlFor:"watchlist",style:{display:"block"},children:"Watchlist"}),t("div",{style:{display:"flex",gap:"1rem"},children:[h.preferences,h.nochange,h.watch,h.unwatch].map(a=>t(Q,{name:"watchlist",value:a,inputProps:{checked:l===a},children:a},a))})]}),t("div",{style:{display:"flex",gap:"1rem"},children:[t(T,{name:"minor",id:"minor",checked:s.editMinor,children:"Minor edit"}),t(T,{name:"reloadAfterSave",id:"reloadAfterSave",checked:s.reloadAfterSave,children:"Reload after save"})]})]}),!1]});o.setContent(x),o.addButton({side:"left",className:"is-primary submit-btn",label:"Submit",keyPress:await this.ctx.preferences.get("quickEdit.keyshortcut.save")||void 0,method:()=>{const a=new FormData(x);o.setLoadingState(!0),this.handleSubmit({wikiPage:c,text:a.get("text"),summary:a.get("summary"),minor:a.get("minor")==="on",section:s.section,createonly:c.pageid===0,watchlist:l}).then(async()=>{o.setOptions({beforeClose:I}),o.close(),this.ctx.modal.notify("success",{title:"Submission Successful",content:"Your changes have been saved."}),a.get("reloadAfterSave")&&(await U(500),location.reload())}).catch(g=>{this.ctx.modal.notify("error",{title:"Submission Error",content:g instanceof Error?g.message:String(g)}),o.setLoadingState(!1)})}},0),o.setOptions({beforeClose:()=>{const a=c.revisions[0]?.content||"";return(x.querySelector("textarea")?.value||"")===a?!0:(this.ctx.modal.confirm({className:"is-primary",title:"Unsaved Changes",content:"All edit contents will be lost after closing the modal. Are you sure you want to close?",center:!0,okBtn:{label:"Give Up",className:"is-danger is-ghost"},cancelBtn:{label:"Continue Editing",className:"is-primary is-ghost"}},g=>(g&&(o.setOptions({beforeClose:I}),o.close()),!0)),!1)}}),this.ctx.emit("quick-edit/wiki-page",{ctx:this.ctx,options:s,modal:o,wikiPage:c});const P=a=>x.querySelector("textarea")?.value===c.revisions[0]?.content?!0:(a.preventDefault(),"You have unsaved changes. Are you sure you want to leave?");window.addEventListener("beforeunload",P),o.on(o.Event.Close,()=>{window.removeEventListener("beforeunload",P)})}async handleSubmit(e){const n=e.wikiPage,l=e.summary||"",r=e.text||"",d=e.minor,s=e.createonly,o=e.watchlist,c=e.section;return n.edit({summary:l,text:r,watchlist:o,section:c},{minor:d,createonly:s})}async getWikiPageFromPayload(e){if(e.revision)return this.ctx.wikiPage.newFromRevision(e.revision,e.section);if(e.pageId)return this.ctx.wikiPage.newFromPageId(e.pageId,e.section);if(e.title)return this.ctx.wikiPage.newFromTitle(e.title,!1,e.section);throw new Error("Invalid payload")}async injectToolbox(e){const n=this.ctx.currentPage.wikiTitle,l=this.ctx.wiki.hasRight("edit")&&n&&n.getNamespaceId()>=0;e.toolbox.addButton({id:"quick-edit",group:"group1",index:0,icon:t("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"icon icon-tabler icons-tabler-outline icon-tabler-edit",children:[t("path",{stroke:"none",d:"M0 0h24v24H0z",fill:"none"}),t("path",{d:"M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"}),t("path",{d:"M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"}),t("path",{d:"M16 5l3 3"})]}),buttonProps:{disabled:!l},tooltip:l?"Quick Edit":"Not editable",onClick:()=>{const r=new URLSearchParams(window.location.search).get("oldid");this.showModal({title:n?.getPrefixedText(),revision:r?Number(r):void 0})}})}removeToolbox(e){e.toolbox.removeButton("quick-edit")}}E=K(O);b=J(E,0,"PluginQuickEdit",M,b);X(E,1,b);export{b as PluginQuickEdit};
